<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Proctoring - Student View</title>
    <style>
      /* DEMO STUB - Not final UI */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 900px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        text-align: center;
      }

      .demo-notice {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 30px;
        text-align: center;
        color: #856404;
        font-weight: bold;
      }

      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .input-group {
        flex: 1;
        min-width: 200px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: bold;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }

      .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
      }

      .btn-start {
        background: #28a745;
        color: white;
      }

      .btn-start:hover:not(:disabled) {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn-stop {
        background: #dc3545;
        color: white;
      }

      .btn-stop:hover:not(:disabled) {
        background: #c82333;
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .video-container {
        position: relative;
        margin-bottom: 20px;
        border-radius: 15px;
        overflow: hidden;
        background: #000;
      }

      video {
        width: 100%;
        height: auto;
        display: block;
      }

      .status-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .status-badge {
        padding: 15px 25px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        text-transform: uppercase;
      }

      .status-normal {
        background: #28a745;
        color: white;
      }

      .status-suspicious {
        background: #ffc107;
        color: #333;
      }

      .status-cheating {
        background: #dc3545;
        color: white;
        animation: pulse 1s infinite;
      }

      .status-calibrating {
        background: #17a2b8;
        color: white;
      }

      .status-looking-away {
        background: #fd7e14;
        color: white;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .info-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
      }

      .info-item:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: bold;
        color: #555;
      }

      .info-value {
        color: #333;
      }

      .security-warning {
        background: #dc3545;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        font-weight: bold;
        text-align: center;
        display: none;
      }

      .security-warning.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéì Quiz Proctoring System</h1>
      <div class="demo-notice">‚ö†Ô∏è DEMO STUB ONLY - Not final UI</div>

      <div class="controls">
        <div class="input-group">
          <label for="studentId">Student ID</label>
          <input
            type="text"
            id="studentId"
            placeholder="e.g., STU12345"
            value="STU12345"
          />
        </div>
        <div class="input-group">
          <label for="quizId">Quiz ID</label>
          <input
            type="text"
            id="quizId"
            placeholder="e.g., QUIZ001"
            value="QUIZ001"
          />
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-start" id="startBtn" onclick="startProctoring()">
          üöÄ Start Proctoring
        </button>
        <button
          class="btn btn-stop"
          id="stopBtn"
          onclick="stopProctoring()"
          disabled
        >
          üõë Stop Proctoring
        </button>
      </div>

      <div class="video-container">
        <video id="webcam" autoplay playsinline></video>
        <div class="status-overlay">
          <div class="status-badge status-normal" id="statusBadge">READY</div>
        </div>
      </div>

      <div class="info-panel">
        <div class="info-item">
          <span class="info-label">Session ID:</span>
          <span class="info-value" id="sessionId">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Status:</span>
          <span class="info-value" id="statusText">Not started</span>
        </div>
        <div class="info-item">
          <span class="info-label">Reason:</span>
          <span class="info-value" id="reasonText">-</span>
        </div>
        <div class="info-item">
          <span class="info-label">Confidence:</span>
          <span class="info-value" id="confidenceText">-</span>
        </div>
      </div>

      <div class="security-warning" id="securityWarning"></div>
    </div>

    <script>
      // DEMO STUB - Basic functionality only
      const API_BASE = "http://localhost:8000";

      let sessionId = null;
      let stream = null;
      let processingInterval = null;
      let heartbeatInterval = null;
      let isQuizActive = false;

      const webcamElement = document.getElementById("webcam");
      const statusBadge = document.getElementById("statusBadge");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");

      async function startProctoring() {
        const studentId = document.getElementById("studentId").value;
        const quizId = document.getElementById("quizId").value;

        if (!studentId || !quizId) {
          alert("Please enter Student ID and Quiz ID");
          return;
        }

        try {
          // Start webcam
          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
          });
          webcamElement.srcObject = stream;

          // Start session
          const response = await fetch(`${API_BASE}/proctor/start-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ student_id: studentId, quiz_id: quizId }),
          });

          const data = await response.json();
          sessionId = data.session_id;

          document.getElementById("sessionId").textContent = sessionId;
          document.getElementById("statusText").textContent =
            "Proctoring active";

          // Update UI
          startBtn.disabled = true;
          stopBtn.disabled = false;

          // Enter fullscreen mode
          await enterFullscreen();

          // Activate browser security monitoring
          activateBrowserSecurity();

          // Start processing frames (every 1 second)
          processingInterval = setInterval(processFrame, 1000);

          // Start heartbeat (every 2 seconds)
          heartbeatInterval = setInterval(sendHeartbeat, 2000);
        } catch (error) {
          console.error("Error starting proctoring:", error);
          alert("Failed to start proctoring: " + error.message);
        }
      }

      async function processFrame() {
        if (!sessionId || !stream) return;

        try {
          // Capture frame from video
          const canvas = document.createElement("canvas");
          canvas.width = webcamElement.videoWidth;
          canvas.height = webcamElement.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(webcamElement, 0, 0);

          // Convert to base64
          const frameBase64 = canvas.toDataURL("image/jpeg").split(",")[1];

          // Send to backend
          const response = await fetch(`${API_BASE}/proctor/frame`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              frame_base64: frameBase64,
            }),
          });

          const result = await response.json();

          // Update UI
          updateStatus(result.event, result.reason, result.confidence);
        } catch (error) {
          console.error("Error processing frame:", error);
        }
      }

      function updateStatus(event, reason, confidence) {
        const statusMap = {
          NORMAL: { class: "status-normal", text: "NORMAL" },
          SUSPICIOUS: { class: "status-suspicious", text: "SUSPICIOUS" },
          CHEATING: { class: "status-cheating", text: "CHEATING" },
          CALIBRATING: { class: "status-calibrating", text: "CALIBRATING" },
          LOOKING_AWAY: { class: "status-looking-away", text: "LOOKING AWAY" },
        };

        const status = statusMap[event] || statusMap["NORMAL"];

        statusBadge.className = "status-badge " + status.class;
        statusBadge.textContent = status.text;

        document.getElementById("statusText").textContent = event;
        document.getElementById("reasonText").textContent = reason;
        document.getElementById("confidenceText").textContent =
          (confidence * 100).toFixed(1) + "%";
      }

      async function stopProctoring() {
        if (!sessionId) return;

        try {
          // Stop processing
          if (processingInterval) {
            clearInterval(processingInterval);
            processingInterval = null;
          }

          // Stop heartbeat
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }

          // Deactivate browser security monitoring
          deactivateBrowserSecurity();

          // Exit fullscreen
          exitFullscreen();

          // End session
          const response = await fetch(`${API_BASE}/proctor/end-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId }),
          });

          const summary = await response.json();

          // Stop webcam
          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
            webcamElement.srcObject = null;
            stream = null;
          }

          // Reset UI
          alert(
            `Session ended.\n\nTotal Events: ${summary.total_events}\nSuspicious: ${summary.suspicious_events}\nCheating: ${summary.cheating_events}`
          );

          sessionId = null;
          document.getElementById("sessionId").textContent = "-";
          document.getElementById("statusText").textContent = "Not started";
          document.getElementById("reasonText").textContent = "-";
          document.getElementById("confidenceText").textContent = "-";

          statusBadge.className = "status-badge status-normal";
          statusBadge.textContent = "READY";

          startBtn.disabled = false;
          stopBtn.disabled = true;
        } catch (error) {
          console.error("Error stopping proctoring:", error);
          alert("Failed to stop proctoring: " + error.message);
        }
      }

      // ============================================
      // PHASE 6: BROWSER-SIDE SECURITY
      // ============================================

      // Fullscreen enforcement
      async function enterFullscreen() {
        try {
          await document.documentElement.requestFullscreen();
          console.log("Entered fullscreen mode");
        } catch (error) {
          console.error("Failed to enter fullscreen:", error);
          showSecurityWarning("‚ö† Failed to enter fullscreen mode");
        }
      }

      function exitFullscreen() {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        }
      }

      // Browser security monitoring
      function activateBrowserSecurity() {
        isQuizActive = true;

        // Fullscreen exit detection
        document.addEventListener("fullscreenchange", handleFullscreenChange);

        // Tab switch and visibility detection
        document.addEventListener("visibilitychange", handleVisibilityChange);
        window.addEventListener("blur", handleWindowBlur);
        window.addEventListener("focus", handleWindowFocus);

        console.log("Browser security monitoring activated");
      }

      function deactivateBrowserSecurity() {
        isQuizActive = false;

        document.removeEventListener(
          "fullscreenchange",
          handleFullscreenChange
        );
        document.removeEventListener(
          "visibilitychange",
          handleVisibilityChange
        );
        window.removeEventListener("blur", handleWindowBlur);
        window.removeEventListener("focus", handleWindowFocus);

        console.log("Browser security monitoring deactivated");
      }

      // Event handlers
      function handleFullscreenChange() {
        if (!isQuizActive) return;

        if (!document.fullscreenElement) {
          // User exited fullscreen
          logBrowserEvent("EXIT_FULLSCREEN", "Student exited fullscreen mode");
          showSecurityWarning("‚ö† Fullscreen exited - Violation detected");
        }
      }

      function handleVisibilityChange() {
        if (!isQuizActive) return;

        if (document.hidden) {
          // Tab is hidden
          logBrowserEvent(
            "TAB_SWITCH",
            "Student switched tabs or minimized browser"
          );
          showSecurityWarning("‚ö† Tab switch detected");
        }
      }

      function handleWindowBlur() {
        if (!isQuizActive) return;

        // Window lost focus
        logBrowserEvent("WINDOW_BLUR", "Browser window lost focus");
        showSecurityWarning("‚ö† Window focus lost");
      }

      function handleWindowFocus() {
        if (!isQuizActive) return;
        // Window regained focus - could clear warning if desired
        console.log("Window regained focus");
      }

      // Send browser event to backend
      async function logBrowserEvent(event, message) {
        if (!sessionId) return;

        try {
          await fetch(`${API_BASE}/proctor/browser-event`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              event: event,
              severity: "HIGH",
              timestamp: new Date().toISOString(),
            }),
          });

          console.log(`Browser event logged: ${event}`);
        } catch (error) {
          console.error("Failed to log browser event:", error);
        }
      }

      // Heartbeat mechanism
      async function sendHeartbeat() {
        if (!sessionId) return;

        try {
          await fetch(`${API_BASE}/proctor/heartbeat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              timestamp: new Date().toISOString(),
            }),
          });
        } catch (error) {
          console.error("Heartbeat failed:", error);
        }
      }

      // Show security warning
      function showSecurityWarning(message) {
        const warningElement = document.getElementById("securityWarning");
        warningElement.textContent = message;
        warningElement.classList.add("show");

        // Auto-hide after 5 seconds
        setTimeout(() => {
          warningElement.classList.remove("show");
        }, 5000);
      }
    </script>
  </body>
</html>
